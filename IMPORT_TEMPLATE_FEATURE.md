# 批量导入模板下载功能

## 功能说明

为运动员批量导入功能添加了 CSV 模板下载功能，方便用户按照正确的格式准备数据。

## 新增功能

### 1. 下载模板按钮
在批量导入对话框中添加了醒目的"下载模板"按钮：
- 📥 图标 + 文字说明
- 突出显示在对话框顶部
- 下载后可直接编辑使用

### 2. 智能模板生成
模板内容根据当前比赛自动调整：
- **动态年级列表**：使用当前比赛已创建的年级作为示例
- **说明行**：包含填写提示，使用后可删除
- **多个示例**：提供 4-5 条示例数据供参考
- **UTF-8 BOM**：添加 BOM 标记，确保 Excel 正确识别中文

### 3. 模板内容示例

```csv
年级,班级,姓名,性别,报名项目
# 请删除此说明行,填写示例如下,↓↓↓,"",""
一年级,1班,张三,男,"100米,跳远"
一年级,1班,李四,女,"100米,200米"
一年级,2班,王五,男,"400米,跳高"
二年级,1班,赵六,女,200米
```

## 技术实现

### 路由配置
```ruby
resources :athletes do
  collection do
    get :download_template  # 新增
    post :import
    post :generate_numbers
  end
end
```

### 控制器方法
```ruby
def download_template
  require 'csv'
  
  # 获取当前比赛的年级列表
  grades = @competition.grades.order(:order).pluck(:name)
  
  # 生成 CSV 数据
  csv_data = CSV.generate(encoding: 'UTF-8', ...) do |csv|
    # 标题行
    # 说明行
    # 示例数据（使用实际年级）
  end
  
  # 发送文件（添加 BOM）
  send_data "\uFEFF" + csv_data, ...
end
```

### 视图更新
在 `app/views/athletes/index.html.erb` 中添加：
- 下载模板区域（带背景色突出显示）
- 下载图标和按钮
- 更新了文件格式说明（支持 CSV）

## 使用流程

### 用户操作步骤

1. **打开批量导入对话框**
   - 点击"批量导入"按钮

2. **下载模板**
   - 点击"下载模板"按钮
   - 得到包含示例数据的 CSV 文件
   - 文件名：`运动员导入模板_2025年秋季运动会_20251004.csv`

3. **编辑模板**
   - 用 Excel 或其他电子表格软件打开
   - 删除说明行
   - 按照示例格式填写数据
   - 年级必须使用系统中已有的年级名称
   - 班级如不存在会自动创建

4. **导入数据**
   - 保存编辑后的文件
   - 在对话框中选择文件
   - 点击"开始导入"

## 模板字段说明

| 字段 | 说明 | 示例 | 必填 |
|------|------|------|------|
| 年级 | 必须是系统中已创建的年级 | 一年级 | ✓ |
| 班级 | 不存在会自动创建 | 1班 | ✓ |
| 姓名 | 运动员姓名 | 张三 | ✓ |
| 性别 | 男 或 女 | 男 | ✓ |
| 报名项目 | 多个项目用逗号分隔 | 100米,跳远 | ✗ |

## 注意事项

1. **年级必须预先创建**
   - 导入前需要在系统中创建好年级
   - 年级名称必须完全匹配

2. **文件格式**
   - 支持 .csv、.xls、.xlsx 格式
   - 推荐使用模板直接编辑

3. **项目名称**
   - 报名项目名称必须与系统中的项目名称一致
   - 多个项目用逗号分隔
   - 不存在的项目会被忽略

4. **Excel 兼容性**
   - CSV 文件添加了 UTF-8 BOM
   - Excel 可以正确显示中文

## 文件结构

```
app/
├── controllers/
│   └── athletes_controller.rb     # 新增 download_template 方法
├── views/
│   └── athletes/
│       └── index.html.erb          # 添加下载模板按钮
config/
└── routes.rb                       # 添加 download_template 路由
```

## 测试验证

✅ CSV 生成正确，包含 UTF-8 BOM
✅ 文件名包含运动会名称和日期
✅ 示例数据使用实际年级
✅ 下载后可用 Excel 正常打开
✅ 按模板导入可以成功

## 后续优化建议

1. 支持 Excel (.xlsx) 格式模板下载
2. 在模板中添加数据验证（下拉列表）
3. 提供更详细的填写说明工作表
4. 支持模板中包含已有运动员数据

<%= render "shared/step_bar", step: "schedule" %>
<div class="w-full bg-white p-6 rounded-md shadow-md">
  <div class="w-full flex justify-between items-center mb-8">
    <h1 class="font-bold text-3xl">日程安排</h1>
    <div class="flex space-x-2">
      <% if @schedules.any? %>
        <a href="#formatted-schedule" class="btn btn-outline">查看格式化日程</a>
      <% end %>
      <%= link_to "批量添加", bulk_new_competition_schedules_path(@competition), class: "btn btn-secondary" %>
      <%= link_to "单个添加", new_competition_schedule_path(@competition), class: "btn btn-primary" %>
    </div>
  </div>

  <% if @schedules.any? %>
    <div class="mb-8">
      <% @schedules_by_date.each do |date, schedules| %>
        <div class="mb-8">
          <h2 class="text-2xl font-bold mb-4 flex items-center">
            <span class="badge badge-primary badge-lg mr-3"><%= date.strftime("%m月%d日") %></span>
            <span class="text-gray-600 text-base font-normal">
              星期<%= %w[日 一 二 三 四 五 六][date.wday] %>
            </span>
            <span class="ml-auto text-sm font-normal text-gray-500">
              共 <%= schedules.count %> 场比赛
            </span>
          </h2>

          <table class="table w-full">
            <thead>
              <tr>
                <th>时间</th>
                <th>比赛项目</th>
                <th>组次</th>
                <th>场地</th>
                <th>备注</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody>
              <% schedules.each do |schedule| %>
                <tr class="hover">
                  <td class="whitespace-nowrap">
                    <div class="font-medium"><%= schedule.scheduled_at.strftime("%H:%M") %></div>
                    <% if schedule.end_at %>
                      <div class="text-sm text-gray-500">
                        至 <%= schedule.end_at.strftime("%H:%M") %>
                      </div>
                    <% end %>
                  </td>
                  <td>
                    <div>
                      <p class="font-medium"><%= schedule.heat.competition_event.event.name %></p>
                      <p class="text-sm text-gray-500"><%= schedule.heat.competition_event.event.gender %></p>
                    </div>
                  </td>
                  <td><%= schedule.heat.grade.name %> 第 <%= schedule.heat.heat_number %> 组</td>
                  <td><%= schedule.venue || "-" %></td>
                  <td class="max-w-xs truncate"><%= schedule.notes || "-" %></td>
                  <td>
                    <div class="flex space-x-2">
                      <%= link_to "编辑", edit_competition_schedule_path(@competition, schedule), class: "btn btn-sm" %>
                      <%= button_to "删除", competition_schedule_path(@competition, schedule),
                                   method: :delete,
                                   data: { turbo_confirm: "确定删除此日程吗？" },
                                   class: "btn btn-sm btn-error" %>
                    </div>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% end %>
    </div>
  <% else %>
    <div class="text-center py-12">
      <p class="text-gray-500 text-lg mb-4">暂无日程安排</p>
      <p class="text-gray-400 text-sm mb-6">请先生成径赛分组，然后为每个分组安排时间</p>
      <%= link_to "添加日程", new_competition_schedule_path(@competition), class: "btn btn-primary" %>
    </div>
  <% end %>

  <% if @heats_without_schedule.any? %>
    <div class="mt-8 border-t pt-6">
      <h2 class="font-bold text-xl mb-4">未安排的比赛分组</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <% @heats_without_schedule.each do |heat| %>
          <div class="card bg-gray-50 border border-gray-200">
            <div class="card-body p-4">
              <h3 class="card-title text-base">
                <%= heat.grade.name %> - <%= heat.competition_event.event.name %> - 第 <%= heat.heat_number %> 组
              </h3>
              <p class="text-sm text-gray-600">
                <%= heat.competition_event.event.gender %> | 
                <%= heat.lanes.count %> 名运动员
              </p>
              <%= link_to "安排时间", new_competition_schedule_path(@competition, heat_id: heat.id), 
                         class: "btn btn-sm btn-primary mt-2" %>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>

  <% if @schedules.any? %>
    <div id="formatted-schedule" class="mt-12 border-t pt-8">
      <h2 class="font-bold text-2xl mb-6">格式化日程</h2>
      
      <div class="bg-gray-50 p-6 rounded-lg border border-gray-200">
        <div class="mb-4 text-sm text-gray-600">
          提示：点击下方文本区域全选，然后复制到 Word 中进行编辑
        </div>
        <textarea readonly 
                  class="w-full p-4 font-mono text-sm border border-gray-300 rounded"
                  rows="30"
                  onclick="this.select()"
                  style="resize: vertical;"><% @schedules_by_date.each do |date, schedules| %>竞 赛 日 程
<%= date.strftime("%-m月%-d日") %>上午08:30——12：00
<% track_schedules = schedules.select { |s| s.heat.competition_event.event.event_type == "track" }.sort_by(&:scheduled_at) %><% field_schedules = schedules.select { |s| s.heat.competition_event.event.event_type == "field" }.sort_by(&:scheduled_at) %><% if track_schedules.any? %>
径        赛
<% track_schedules.each_with_index do |schedule, index| %><% event = schedule.heat.competition_event.event %><% heat = schedule.heat %><% participant_count = heat.lanes.count %><% take_count = (participant_count * 0.6).ceil %><% if heat.grade %><% gender_text = event.gender == "男" ? "男子组" : (event.gender == "女" ? "女子组" : "#{event.gender}组") %><% event_name = "#{heat.grade.name}#{gender_text}#{event.name}" %><% else %><% event_name = "#{event.name}(#{event.gender})" %><% end %><%= index + 1 %>、<%= event_name %>预决赛     <%= participant_count %>人<%= heat.heat_number %>组  取 <%= take_count %>名   <%= schedule.scheduled_at.strftime("%-H:%M") %>
<% end %><% end %><% if field_schedules.any? %>
田         赛
<% field_schedules.each_with_index do |schedule, index| %><% event = schedule.heat.competition_event.event %><% heat = schedule.heat %><% participant_count = heat.lanes.count %><% take_count = (participant_count * 0.6).ceil %><% gender_text = event.gender == "男" ? "男子组" : (event.gender == "女" ? "女子组" : "#{event.gender}组") %><% event_name = "#{heat.grade.name}#{gender_text}#{event.name}" %><%= index + 1 %>、<%= event_name %>预决赛       <%= participant_count %>人      取<%= take_count %>名   <%= schedule.scheduled_at.strftime("%-H:%M") %>
<% end %><% end %>
<% end %>

各 班 级 名 单

<% @grades.each do |grade| %><%= grade.name %>组
<% grade.klasses.order(:name).each do |klass| %><% athletes = klass.athletes.order(:number) %><% if athletes.any? %>
<%= class_name_to_chinese(klass.name) %>
运动员：
<%= athletes.map { |a| "#{a.number} #{a.name}" }.join(" ") %>
<% end %><% end %>
<% end %>

竞 赛 分 组

<% heats_by_grade_gender = @schedules.map(&:heat).uniq.group_by do |heat| event = heat.competition_event.event; [heat.grade&.name || "其他", event.gender, event.event_type] end.sort_by { |key, _| [key[0], key[1] == "男" ? 0 : 1, key[2] == "track" ? 0 : 1] } %><% heats_by_grade_gender.each do |(grade_name, gender, event_type), grade_heats| %><%= grade_name %> <%= gender == "男" ? "男子组" : "女子组" %> <%= event_type == "track" ? "径赛" : "田赛" %>
<% heats_by_event = grade_heats.group_by { |h| h.competition_event.event } %><% heats_by_event.each_with_index do |(event, event_heats), event_index| %><% event_heats_sorted = event_heats.sort_by(&:heat_number) %><% total_participants = event_heats_sorted.sum { |h| h.lanes.count } %><% total_groups = event_heats_sorted.count %><% take_count = (total_participants * 0.6).ceil %>
<%= event_index + 1 %>、<%= event.name %>预决赛，<%= total_participants %>人<%= total_groups %>组，取<%= take_count %>名
<% event_heats_sorted.each do |heat| %>
第<%= number_to_chinese(heat.heat_number) %>组
道次<% heat.lanes.order(:lane_number).each do |lane| %>	<%= %w[一 二 三 四 五 六 七 八][lane.lane_number - 1] %><% end %>
姓名<% heat.lanes.order(:lane_number).each do |lane| %><% lane_athlete = lane.lane_athletes.first %><% athlete = lane_athlete&.athlete %>	<%= athlete&.name || "" %><% end %>
号码<% heat.lanes.order(:lane_number).each do |lane| %><% lane_athlete = lane.lane_athletes.first %><% athlete = lane_athlete&.athlete %>	<%= athlete&.number || "" %><% end %>
班级<% heat.lanes.order(:lane_number).each do |lane| %><% lane_athlete = lane.lane_athletes.first %><% athlete = lane_athlete&.athlete %>	<%= class_name_to_chinese(athlete&.klass&.name) || "" %><% end %>
<% end %><% end %><% end %></textarea>
        <div class="mt-4">
          <button onclick="copyToClipboard()" class="btn btn-primary btn-sm">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
            </svg>
            复制到剪贴板
          </button>
        </div>
      </div>
    </div>
    
    <script>
      function copyToClipboard() {
        const textarea = document.querySelector('#formatted-schedule textarea');
        textarea.select();
        document.execCommand('copy');
        
        const btn = event.target.closest('button');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>已复制！';
        
        setTimeout(() => {
          btn.innerHTML = originalText;
        }, 2000);
      }
    </script>
  <% end %>

  <div class="w-full flex justify-end mt-8">
    <%= link_to "上一步", competition_heats_path(@competition), class: "btn mr-2" %>
    <%= link_to "完成", competition_path(@competition), class: "btn btn-primary" %>
  </div>
</div>

<%= form_with(model: [@competition, schedule], class: "contents", data: { controller: "schedule-time" }) do |form| %>
  <% if schedule.errors.any? %>
    <div id="error_explanation" class="bg-red-50 text-red-500 px-3 py-2 font-medium rounded-md mt-3">
      <h2><%= pluralize(schedule.errors.count, "error") %> prohibited this schedule from being saved:</h2>
      <ul class="list-disc ml-6">
        <% schedule.errors.each do |error| %>
          <li><%= error.full_message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="my-5">
    <%= form.label "比赛分组" %>
    <%= form.collection_select :heat_id, available_heats, :id, 
                               ->(heat) { "#{heat.competition_event.event.name} - 第#{heat.heat_number}组" },
                               local_assigns[:is_edit] ? {} : { selected: params[:heat_id] },
                               { 
                                 class: "select select-bordered w-full mt-2",
                                 data: { 
                                   schedule_time_target: "heatSelect",
                                   action: "change->schedule-time#updateAvgTime",
                                   heats: available_heats.map { |h| { id: h.id, avg_time: h.competition_event.event.avg_time } }.to_json
                                 }
                               } %>
  </div>

  <div class="my-5">
    <%= form.label "比赛日期" %>
    <%= form.date_field :scheduled_date, 
                        value: (schedule.scheduled_at ? schedule.scheduled_at.to_date : @competition.start_date),
                        min: @competition.start_date,
                        max: @competition.end_date,
                        class: "input block mt-2 w-full",
                        data: { 
                          schedule_time_target: "dateInput",
                          action: "change->schedule-time#calculateEndTime"
                        } %>
  </div>

  <div class="my-5">
    <%= form.label "开始时间" %>
    <%= form.time_field :scheduled_time, 
                        value: (schedule.scheduled_at ? schedule.scheduled_at.strftime("%H:%M") : @competition.daily_start_time),
                        class: "input block mt-2 w-full",
                        data: { 
                          schedule_time_target: "timeInput",
                          action: "change->schedule-time#calculateEndTime"
                        } %>
  </div>

  <div class="my-5">
    <%= form.label "结束时间" %>
    <div class="flex items-center gap-2 mt-2">
      <input type="text" 
             readonly 
             data-schedule-time-target="endTimeDisplay"
             class="input bg-gray-100 flex-1"
             placeholder="将自动计算">
      <span class="text-sm text-gray-500">
        (自动计算：开始时间 + <span data-schedule-time-target="avgTimeDisplay">--</span> 分钟)
      </span>
    </div>
    <%= form.hidden_field :scheduled_at, data: { schedule_time_target: "scheduledAtHidden" } %>
    <%= form.hidden_field :end_at, data: { schedule_time_target: "endAtHidden" } %>
  </div>

  <div class="my-5">
    <%= form.label "场地" %>
    <%= form.text_field :venue, class: "input block mt-2 w-full", placeholder: "例如：田径场跑道" %>
  </div>

  <div class="my-5">
    <%= form.label "备注" %>
    <%= form.text_area :notes, rows: 3, class: "textarea textarea-bordered block mt-2 w-full", placeholder: "其他说明信息" %>
  </div>

  <div class="inline mt-6">
    <%= form.submit "保存", class: "btn btn-primary mr-2" %>
    <%= link_to "取消", competition_schedules_path(@competition), class: "btn" %>
  </div>
<% end %>
